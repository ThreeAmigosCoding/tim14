{% extends "base.html" %}
{% block main_canvas %}

<style>
    circle{
    fill: #00FFF5;
    }
    text{
        fill: #222831;
    }
    line{
        stroke: white;
    }
</style>

<style>

    .node-data {
        width: 200px;
        height: 300px;
        overflow-y: auto;
        display: block;
        position: absolute;
        bottom: 0;
        right: 0;
        background-color: #393E46;
        padding: 20px;
        border: none;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        margin: 0;
        z-index: 9999;
    }

    .node-data p {
        word-wrap: break-word;
    }

</style>

<div style="position: relative; border: none; margin: 0; padding: 0;">
    <div id="node-data" class="node-data">
        <h2 style="margin: 0" id="node-data-title">Node Data</h2>
        <p id="nodeData"></p>
    </div>
</div>

<script src='https://d3js.org/d3.v3.min.js'></script>
<script>
    let nodes={
        {% for node in nodes %}
            {% if node.enabled == True %}
                "{{node.node_id}}":{id:"{{node.node_id}}", data: [
                    {% for attribute in node.data.all %}
                        "{{ attribute }}",
                    {% endfor %}
                ], node_name:"{{ node.name }}"},
            {% endif %}
        {% endfor %}
        };
    let edges=[
        {% for edge in edges %}
            {% if edge.enabled == True %}
                {source:"{{edge.start_node.node_id}}",target:"{{edge.end_node.node_id}}"},
            {% endif %}
        {% endfor %}
    ]
    edges.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });

    const width = document.getElementById("main-canvas-svg").clientWidth;
    const height = document.getElementById("main-canvas-svg").clientHeight;

    function formatNodeData(data) {
        let formatedData = "";
        for (let atr of data)
            formatedData += atr + "\n\n";
        return formatedData;
    }

    let force = d3.layout.force()
        .size([width, height])
        .nodes(d3.values(nodes))
        .links(edges)
        .on("tick", tick)
        .linkDistance(60)
        .linkStrength(3.5)
        .charge(-350).start();

    let svg = d3.select('svg#main-canvas-svg').append("g");
    let edgeComp = svg.selectAll('.edge')
        .data(edges)
        .enter().append('line')
        .attr('class', 'edge');
    let nodeComp = svg.selectAll('.node')
        .data(force.nodes())
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d){return d.id;})
        .attr('data', function(d){return d.data;})
        .on("click", function(d) {
            document.getElementById("nodeData").innerText = formatNodeData(d.data);
            document.getElementById("node-data-title").innerText = d.id + " : " + d.node_name;
        });

    d3.selectAll('.node').each(function(d){
        d3.select("g[id='"+d.id+"']").append('circle').attr('r', 12);
        d3.select("g[id='"+d.id+"']").append('text').attr('x',0).attr('y',3)
        .attr('text-anchor','middle')
        .attr('font-size',10).attr('font-family','sans-serif').text(d.id);
    });

    function updateNodes(){
        nodeComp.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";})
            .call(force.drag);
    }
    function updateEdges(){
        edgeComp.attr('x1', function(d){
                return d.source.x;
            })
            .attr('y1', function(d){
                return d.source.y;
            })
            .attr('x2', function(d){
                return d.target.x;
            })
            .attr('y2', function(d){
                return d.target.y;
            });
    }

    function tick() {
        updateNodes();
        updateEdges();
        d3.selectAll("#main-canvas-svg g g").on("mousedown", function() {
        d3.event.stopImmediatePropagation(); });

        if (typeof updateBirdView === 'function') {
            updateBirdView();
        }
    }

</script>
{% endblock %}